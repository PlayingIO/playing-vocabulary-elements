<link rel="import" href="../../iron-form-element-behavior/iron-form-element-behavior.html">
<link rel="import" href="../../iron-validatable-behavior/iron-validatable-behavior.html">
<link rel="import" href="../../mostly-elements/widgets/mostly-select2.html">
<link rel="import" href="../../mostly-elements/behaviors/mostly-i18n-behavior.html">

<!--
An element for selecting one or more entries from a given vocabulary.

    <playing-vocabulary-suggestion vocabulary-name="l10nsubjects"
            multiple="true"
            dbl10n="true"
            value="{{suggestions}}"></playing-vocabulary-suggestion>

@group Playing Widgets
@element playing-vocabulary-suggestion
-->
<dom-module id="playing-vocabulary-suggestion">
  <template>

    <style>
      :host {
        display: block;
      }
    </style>

    <mostly-select2 id="s2"
            path="vocabularies"
            operation="suggestions"
            label="[[label]]"
            min-chars="[[minChars]]"
            multiple="[[multiple]]"
            params="[[params]]"
            placeholder="[[placeholder]]"
            readonly="[[readonly]]"
            value="{{value}}"
            selected-items="{{selectedItems}}"
            selection-formatter="[[selectionFormatter]]"
            required="[[required]]"
            invalid="[[invalid]]"
            init-selection="[[initSelection]]">
    </mostly-select2>

  </template>
  <script>
    Polymer({
      is: 'playing-vocabulary-suggestion',
      behaviors: [Mostly.I18nBehavior, Polymer.IronFormElementBehavior, Polymer.IronValidatableBehavior],
      properties: {

        /**
         * Name of the vocabulary.
         */
        vocabularyName: {
          type: String
        },

        /**
         * Checking this option means that the labels are localized with translations provided
         * in the vocabulary itself (i.e. in fields). Otherwise labels are translated as usual
         * picking values in messages*.properties files.
         */
        dbl10n: {type: Boolean, value: false},

        /**
         * Label.
         */
        label: String,

        /**
         * Computed parameters for the `Directory.SuggestEntries` operation.
         */
        params: {
          type: Object,
          computed: '_computeParams(vocabularyName, dbl10n)'
        },

        /**
         * Selected value(s).
         */
        value: {
          type: String,
          notify: true
        },

        /**
         * Set to `true` to allow multiple selection.
         */
        multiple: {
          type: Boolean,
          value: false
        },

        /**
         * Set to `true` for read only mode.
         */
        readonly: {
          type: Boolean,
          value: false
        },

        /**
         * Minimum number of chars to trigger the suggestions.
         */
        minChars: {
          type: Number,
          value: 3
        },

        /**
         * Placeholder.
         */
        placeholder: String,

        /**
         * Selected items.
         */
        selectedItems: {
          type: Object,
          notify: true
        },

        /**
         * Formatter for a selected entry.
         */
        selectionFormatter: {
          type: Function,
          value: function() {
            return this._selectionFormatter.bind(this);
          }
        },

        /**
         * Formatter for initial selection.
         */
        initSelection: {
          type: Function,
          value: function () {
            return this._initSelection.bind(this);
          }
        }
      },

      /* Override method from Polymer.IronValidatableBehavior. */
      _getValidity: function() {
        return this.$.s2._getValidity();
      },

      /* Override method from Polymer.IronValidatableBehavior. */
      validate: function(value) {
        this.invalid = !this.$.s2.validate();
        return !this.invalid;
      },

      _computeParams: function() {
        return this.params = {
          name: this.vocabularyName,
          dbl10n: this.dbl10n,
          localize : true,
          lang: (window.mostly.I18n.language) ? window.mostly.I18n.language.split('-')[0] : 'en'
        };
      },

      _selectionFormatter: function(entry) {
        return entry.displayLabel;
      },

      _initSelection: function(element, callback) {
        if (!this.multiple) {
          return callback(this._resolveEntry(this.value));
        }
        return callback(
          this.value.map((entry) => this._resolveEntry(entry))
        );
      },

      _resolveEntry: function(entry) {
        if (entry && entry['type'] && entry['type'] === 'vocabulary') {
          if (entry && entry.label) {
            return {
              id: entry.id,
              displayLabel: this.i18n(entry.label)
            };
          } else {
            var label = 'label_' + ((window.mostly.I18n.language) ? window.mostly.I18n.language.split('-')[0] : 'en');
            return {
              id: entry.id,
              displayLabel: entry[label] || entry['label_en']
            };
          }
        }
        return {
          id: entry,
          displayLabel: entry
        };
      }

    });
  </script>
</dom-module>
